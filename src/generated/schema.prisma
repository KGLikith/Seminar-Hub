generator client {
  provider = "prisma-client-js"
  output   = "../src/generated"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum UserRole {
  teacher
  hod
  tech_staff
}

enum BookingStatus {
  pending
  approved
  rejected
  completed
  cancelled
}

enum EquipmentCondition {
  active
  not_working
  under_repair
}

enum HallStatus {
  available
  booked
  ongoing
  maintenance
}

enum ComponentType {
  projector
  screen
  audio_system
  microphone
  whiteboard
  smartboard
  ac
  lighting
  camera
  other

  @@map("component_type")
}

enum EquipmentType {
  speaker
  microphone
  mixer
  amplifier
  laptop
  pointer
  cable
  adapter
  router
  tablet
  camera
  stand
  projector
  other

  @@map("equipment_type")
}

enum ComponentStatus {
  operational
  maintenance_required
  under_maintenance
  non_operational

  @@map("component_status")
}

enum MaintenanceRequestStatus {
  pending
  approved
  rejected
  completed

  @@map("maintenance_request_status")
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  hod_id      String?  @unique
  hod_profile Profile? @relation("DepartmentHOD", fields: [hod_id], references: [id], onDelete: SetNull)

  profiles Profile[]
  halls    SeminarHall[]
}

// WIP: Department names

enum DepartmentName {
  Computer_Science
  Electrical_Engineering
  Mechanical_Engineering
  Civil_Engineering
  Chemistry
  Physics
  IEM
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  clerkId    String   @unique
  image_url  String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  profile Profile?
}

model Profile {
  id         String   @id @default(uuid())
  clerkId    String   @unique
  email      String
  name       String
  phone      String?
  avatar_url String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  department_id String?
  department    Department? @relation(fields: [department_id], references: [id], onDelete: SetNull)

  hod_of_department Department? @relation("DepartmentHOD")

  user_id String? @unique
  user    User?   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  roles UserRoleAssignment[]

  hallAssignments  HallTechStaff[]
  equipmentUpdated Equipment[]     @relation("updated_by_equipment")
  equipmentLogs    EquipmentLog[]  @relation("updated_by_log")

  teacherBookings Booking[] @relation("teacher_bookings")
  hodBookings     Booking[] @relation("hod_approval")

  bookingLogsPerformed BookingLog[]   @relation("log_performed_by")
  notifications        Notification[]

  maintenanceRequestsCreated MaintenanceRequest[]      @relation("tech_staff_fk")
  favoriteHalls              FavoriteHall[]
  componentMaintenanceLogs   ComponentMaintenanceLog[] @relation("PerformedByProfile")
  maintenanceRequests        MaintenanceRequest[]

  media BookingMedia[]
}

model UserRoleAssignment {
  id         String   @id @default(uuid())
  profile_id String
  role       UserRole
  created_at DateTime @default(now())

  profile Profile @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@unique([profile_id, role])
}

model SeminarHall {
  id               String     @id @default(uuid())
  name             String
  seating_capacity Int
  location         String
  description      String?
  image_url        String?
  status           HallStatus @default(available)
  created_at       DateTime   @default(now())
  updated_at       DateTime   @updatedAt

  department_id String
  department    Department @relation(fields: [department_id], references: [id])

  images              HallImage[]
  components          HallComponent[]
  maintenanceRequests MaintenanceRequest[]
  favoriteUsers       FavoriteHall[]
  hallTechStaffs      HallTechStaff[]
  equipment           Equipment[]
  bookings            Booking[]

  @@map("seminar_halls")
}

model HallImage {
  id         String   @id @default(uuid())
  hall_id    String
  image_url  String
  created_at DateTime @default(now())

  hall SeminarHall @relation(fields: [hall_id], references: [id], onDelete: Cascade)

  @@index([hall_id])
}

model FavoriteHall {
  id         String   @id @default(uuid())
  user_id    String
  hall_id    String
  created_at DateTime @default(now())

  user Profile     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  hall SeminarHall @relation(fields: [hall_id], references: [id], onDelete: Cascade)

  @@unique([user_id, hall_id])
  @@index([user_id])
  @@index([hall_id])
  @@map("favorite_halls")
}

model HallTechStaff {
  id            String   @id @default(uuid())
  hall_id       String
  tech_staff_id String
  created_at    DateTime @default(now())

  hall       SeminarHall @relation(fields: [hall_id], references: [id], onDelete: Cascade)
  tech_staff Profile     @relation(fields: [tech_staff_id], references: [id])

  @@unique([hall_id, tech_staff_id])
  @@index([hall_id])
  @@index([tech_staff_id])
}

model Equipment {
  id              String             @id @default(uuid())
  name            String
  type            EquipmentType
  serial_number   String?
  condition       EquipmentCondition @default(active)
  last_updated_at DateTime           @default(now())
  created_at      DateTime           @default(now())

  hall_id String
  hall    SeminarHall @relation(fields: [hall_id], references: [id], onDelete: Cascade)

  last_updated_by String?
  updated_by      Profile? @relation("updated_by_equipment", fields: [last_updated_by], references: [id], onDelete: SetNull)

  logs                EquipmentLog[]
  maintenanceRequests MaintenanceRequest[]

  @@index([hall_id])
}

model EquipmentLog {
  id           String @id @default(uuid())
  equipment_id String

  action          MaintenanceAction
  condition_after EquipmentCondition?
  notes           String?

  created_at DateTime @default(now())

  updated_by String
  user       Profile @relation("updated_by_log", fields: [updated_by], references: [id])

  equipment Equipment @relation(fields: [equipment_id], references: [id], onDelete: Cascade)

  @@index([equipment_id])
}

model Booking {
  id                    String        @id @default(uuid())
  booking_date          DateTime
  start_time            DateTime
  end_time              DateTime
  purpose               String
  permission_letter_url String
  status                BookingStatus @default(pending)
  approved_at           DateTime?
  rejection_reason      String?
  session_summary       String?
  ai_summary            Json?
  created_at            DateTime      @default(now())
  updated_at            DateTime      @updatedAt

  expected_participants Int?
  special_requirements  String?

  hall_id String
  hall    SeminarHall @relation(fields: [hall_id], references: [id], onDelete: Cascade)

  teacher_id String
  teacher    Profile @relation("teacher_bookings", fields: [teacher_id], references: [id], onDelete: Cascade)

  hod_id String?
  hod    Profile? @relation("hod_approval", fields: [hod_id], references: [id], onDelete: SetNull)

  logs          BookingLog[]
  notifications Notification[]
  emailLogs     EmailLog[]
  media         BookingMedia[]

  @@index([status])
  @@index([hod_id])
}

model BookingLog {
  id              String         @id @default(uuid())
  action          String
  previous_status BookingStatus?
  new_status      BookingStatus?
  notes           String?
  metadata        Json?
  created_at      DateTime       @default(now())

  booking_id String
  booking    Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  performed_by String
  performer    Profile @relation("log_performed_by", fields: [performed_by], references: [id], onDelete: Cascade)

  @@index([booking_id])
}

model BookingMedia {
  id          String   @id @default(uuid())
  booking_id  String
  url         String
  uploaded_by String
  created_at  DateTime @default(now())

  booking  Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  uploader Profile @relation(fields: [uploaded_by], references: [id], onDelete: Cascade)

  @@index([booking_id])
}

model Notification {
  id         String   @id @default(uuid())
  title      String
  message    String
  type       String
  read       Boolean  @default(false)
  created_at DateTime @default(now())

  user_id String
  user    Profile @relation(fields: [user_id], references: [id], onDelete: Cascade)

  related_booking_id String?
  relatedBooking     Booking? @relation(fields: [related_booking_id], references: [id], onDelete: SetNull)

  @@index([user_id])
}

model HallComponent {
  id                String          @id @default(uuid())
  hall_id           String
  name              String
  type              ComponentType
  status            ComponentStatus @default(operational)
  location          String?
  installation_date DateTime?       @db.Date
  last_maintenance  DateTime?
  notes             String?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt

  hall                SeminarHall               @relation(fields: [hall_id], references: [id], onDelete: Cascade)
  logs                ComponentMaintenanceLog[]
  maintenanceRequests MaintenanceRequest[]

  @@index([hall_id])
  @@index([status])
  @@map("hall_components")
}

model ComponentMaintenanceLog {
  id           String @id @default(uuid())
  component_id String

  action       MaintenanceAction
  status_after ComponentStatus?
  notes        String?

  performed_by String
  created_at   DateTime @default(now())

  component HallComponent @relation(fields: [component_id], references: [id], onDelete: Cascade)
  performer Profile       @relation("PerformedByProfile", fields: [performed_by], references: [id], onDelete: Cascade)

  @@index([component_id])
  @@map("component_maintenance_logs")
}

enum MaintenanceTarget {
  hall
  equipment
  component

  @@map("maintenance_target")
}

model MaintenanceRequest {
  id            String @id @default(uuid())
  hall_id       String
  tech_staff_id String

  component_id String?
  equipment_id String?

  target                   MaintenanceTarget
  requested_component_type ComponentType?
  requested_equipment_type EquipmentType?

  request_type MaintenanceRequestType
  priority     MaintenancePriority      @default(medium)
  status       MaintenanceRequestStatus @default(pending)

  title       String
  description String

  hod_id           String?
  approved_at      DateTime?
  rejection_reason String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  hall      SeminarHall    @relation(fields: [hall_id], references: [id], onDelete: Cascade)
  component HallComponent? @relation(fields: [component_id], references: [id], onDelete: SetNull)
  equipment Equipment?     @relation(fields: [equipment_id], references: [id], onDelete: SetNull)
  techStaff Profile        @relation("tech_staff_fk", fields: [tech_staff_id], references: [id], onDelete: Cascade)
  hod       Profile?       @relation(fields: [hod_id], references: [id], onDelete: SetNull)

  @@index([hall_id])
  @@index([tech_staff_id])
  @@index([status])
  @@map("maintenance_requests")
}

enum MaintenanceRequestType {
  new_installation
  repair
  replacement
  inspection
  calibration
  preventive
  general_issue

  @@map("maintenance_request_type")
}

enum MaintenancePriority {
  low
  medium
  high
  critical

  @@map("maintenance_priority")
}

enum MaintenanceAction {
  created
  inspected
  repaired
  replaced
  calibrated
  cleaned
  tested
  marked_non_operational
  marked_operational
  completed

  @@map("maintenance_action")
}

model EmailLog {
  id              String   @id @default(uuid())
  booking_id      String?
  recipient_email String
  email_type      String
  sent_at         DateTime @default(now())
  status          String   @default("sent")
  error_message   String?

  booking Booking? @relation(fields: [booking_id], references: [id], onDelete: SetNull)
}
